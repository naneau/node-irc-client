(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m=function(a,b){return function(){return a.apply(b,arguments)}};h=function(){function b(b){this.createChannelList(),this.setupSocket(),this.appView=new a({el:b,channelList:this.channelList}),this.appView.render()}b.prototype.setupSocket=function(){this.socket=new io.Socket,this.socket.on("message",m(function(a){if(a.message==="channelMessage")return this.channelList.addMessage(a.to,a.text,a.from);if(a.message==="channelList")return this.channelList.initWithChannelList(a.channels)},this));return this.socket.connect()},b.prototype.createChannelList=function(){this.channelList=new c;return this.channelList.bind("channelInput",m(function(a,b){return this.socket.send({message:"channelMessage",channel:a.get("name"),text:b.get("message")})},this))};return b}(),window.IRCApp=h,a=Backbone.View.extend({initialize:function(a){this.channelList=a.channelList,this.channelList.bind("change:active",m(function(a,b){if(b)return this.renderChannel()},this));return $(window).resize(m(function(){return this.resize()},this))},renderChannel:function(){var a;a=this.channelList.getActive(),this.channelWrapper.children().hide(),a.chatView==null&&(a.chatView=new f({channel:a}),a.chatView.render(),this.channelWrapper.append(a.chatView.el)),a.chatView.el.show(),a.chatView.resize();return this.resize()},resize:function(){this.right.width($(window).width()-(this.left.width()+5)),this.right.height($("body").innerHeight()),this.channelWrapper.height(this.right.height());return this.channelWrapper.children().height(this.right.height())},render:function(){var a;a=$(l.prototype.renderTemplate("app")),this.el.html(a),this.right=a.find("#right"),this.left=a.find("#left"),this.channelWrapper=this.$("#channel"),this.channelListView=new d({el:a.find("#channel-list"),model:this.channelList}),this.channelListView.render();return this.resize()}}),g=123123,b=Backbone.Model.extend({initialize:function(){this.set({active:!1}),this.messageList=new j,this.inputList=new j;return this.inputList.bind("add",m(function(a){return this.messageList.add(a.toJSON())},this))},addMessage:function(a,b){return this.messageList.add(new i({message:a,from:b}))}}),c=Backbone.Collection.extend({model:b,initialize:function(){return this.bind("change:active",m(function(a,b){if(b)return this.each(m(function(b){if(b.get("id")!==a.get("id"))return b.set({active:!1})},this))},this))},createChannel:function(a){var c;c=new b({id:a,name:a}),c.inputList.bind("add",m(function(a){return this.trigger("channelInput",c,a)},this));return c},initWithChannelList:function(a){var b,c,d,e,f;b=[],d=m(function(a){return b.push(this.createChannel(a))},this);for(e=0,f=a.length;e<f;e++)c=a[e],d(c);this.refresh(b);if(this.first())return this.makeActive(this.first())},getChannel:function(a){var b;b=this.get(a),b==null&&this.add(this.createChannel(a));return b},addMessage:function(a,c,d){a instanceof b||(a=this.getChannel(a));return a.addMessage(c,d)},getActive:function(){var a;if(this.length=0)throw"No channels, can't retrieve active";a=this.detect(function(a){return a.get("active")});if(a==null)return this.first();return a},makeActive:function(a){this.each(function(a){return a.set({active:!1})}),a instanceof b||(a=this.getChannel(a));return a.set({active:!0})}}),e=Backbone.View.extend({events:{click:"makeActive"},initialize:function(){this.unread=0,this.model.bind("change:active",m(function(){if(this.model.get("active")){this.hideMessageCount();return $(this.el).addClass("active")}return $(this.el).removeClass("active")},this));return this.model.messageList.bind("add",m(function(){if(!this.model.get("active")){this.unread++;return this.showUnread()}},this))},makeActive:function(){if(!this.model.get("active"))return this.model.set({active:!0})},hideMessageCount:function(){this.unread=0,this.messageCountEl.text(this.unread);return this.messageCountEl.hide()},showUnread:function(){if(!this.model.get("active")){this.messageCountEl.text(this.unread);return this.messageCountEl.show()}},render:function(){var a,b;a=$(l.prototype.renderTemplate("channelListChannel")),this.el=a,this.delegateEvents(),b=this.el.find(".name"),b.text(this.model.get("name")),this.messageCountEl=this.el.find(".message-count"),this.hideMessageCount();return this}}),d=Backbone.View.extend({initialize:function(){return this.model.bind("refresh",m(function(){return this.render()},this))},changeConversation:function(a){var b,c;a.preventDefault(),c=$(a.target).closest("li"),b=this.$(".conversations li"),b.removeClass("active");return c.addClass("active")},render:function(){var a,b;a=$(l.prototype.renderTemplate("channelList")),b=a.find("ul"),this.model.each(function(a){a.view==null&&(a.view=new e({model:a})),a.view.render();return b.append(a.view.el)});return this.el.html(a)}}),i=Backbone.Model.extend({initialize:function(){return this.set({read:!1,received:new Date})}}),k=Backbone.View.extend({initialize:function(a){return _.bindAll(this,"render")},render:function(){this.el=$(l.prototype.renderTemplate("message",this.model.toJSON()));return this}}),j=Backbone.Collection.extend({model:i}),f=Backbone.View.extend({events:{"keydown     input":"inputKey"},initialize:function(a){_.bindAll(this,"render","newMessage","renderMessage","inputKey"),this.el=$(this.el),this.channel=a.channel,this.messageList=a.channel.messageList,this.inputList=a.channel.inputList;return this.messageList.bind("add",this.newMessage)},newMessage:function(a){return this.renderMessage(a)},renderMessage:function(a){this.chatList||(this.chatList=this.$(".chat")),a.view||(a.view=new k({model:a})),a.view.render(),this.chatList.append(a.view.el);return this.resize()},inputKey:function(a){var b;a.keyCode===13&&a.preventDefault(),b=$(a.target).val(),a.keyCode===13&&b.length>0&&this.inputList.add(new i({message:b,from:"you"})),(a.keyCode===13||a.keyCode===27)&&$(a.target).val("");return $(window).resize(m(function(){return this.resize()},this))},resize:function(){this.title.width(this.el.innerWidth()-40),this.el.attr({scrollTop:this.el.attr("scrollHeight")}),this.input.width(this.el.width()-30);return this.input.focus()},render:function(){var a;a=l.prototype.renderTemplate("chat",this.channel.toJSON()),this.el=$(a),this.delegateEvents(),this.chatList=this.$("ul"),this.input=this.$("input"),this.title=this.$("h2"),this.messageList.each(m(function(a){return this.renderMessage(a)},this)),this.resize();return this}}),l=function(){function a(){}a.prototype.renderTemplate=function(a,b){b==null&&(b={}),b.template=a;return window.template({context:b})};return a}()}).call(this)